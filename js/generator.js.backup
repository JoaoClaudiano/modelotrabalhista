// generator.js - Geração específica de documentos para ModeloTrabalhista

class DocumentGenerator {
    constructor() {
        // Constantes para validação de tamanho de campos
        this.MAX_SHORT_TEXT_LENGTH = 500;
        this.MAX_LONG_TEXT_LENGTH = 2000;
        this.LONG_TEXT_FIELDS = ['Reason', 'Agenda', 'Conditions', 'Description'];
        
        // Estilos base para container do documento (otimizado para PDF de 1 página A4 e captura com html2canvas)
        // box-sizing: border-box - garante que padding não aumenta dimensões totais
        // page-break-inside: avoid - evita quebra dentro do container
        // line-height: 1.5 - espaçamento padrão para corpo do texto
        // padding: 20px - ajustado para melhor captura em PDF
        // background-color: white - garante fundo branco na captura
        // color: black - garante texto preto para melhor legibilidade
        this.DOCUMENT_CONTAINER_STYLE = 'font-family: Arial, sans-serif; line-height: 1.5; width: 100%; margin: 0; padding: 20px; box-sizing: border-box; background-color: white; color: black;';
        
        // Array de meses em português para formatação de datas
        this.MONTHS_PT = [
            'janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho',
            'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
        ];
        
        this.templates = {
            demissao: this.generateResignationLetter.bind(this),
            ferias: this.generateVacationRequest.bind(this),
            advertencia: this.generateWarningLetter.bind(this),
            atestado: this.generateCertificate.bind(this),
            rescisao: this.generateSeveranceAgreement.bind(this),
            reuniao: this.generateMeetingConvocation.bind(this)
        };
        
        // Campos obrigatórios por tipo de documento
        this.REQUIRED_FIELDS = {
            demissao: ['employeeName', 'employeePosition', 'companyName', 'effectiveDate', 'noticePeriod', 'CPF', 'CTPS'],
            ferias: ['employeeName', 'employeePosition', 'vacationPeriod', 'vacationDays'],
            advertencia: ['employeeName', 'employeePosition', 'incidentDate', 'warningReason', 'severity'],
            atestado: ['employeeName', 'employeePosition', 'certificateStart', 'certificateEnd', 'certificateReason'],
            rescisao: ['employeeName', 'employeePosition', 'companyName', 'severanceValue', 'paymentDate', 'CPF', 'CTPS'],
            reuniao: ['meetingDate', 'meetingTime', 'meetingLocation', 'meetingAgenda']
        };
        
        // Metadados e instruções de preenchimento por documento
        this.DOCUMENT_METADATA = {
            demissao: {
                name: 'Pedido de Demissão',
                description: 'Este documento serve para formalizar a manifestação de vontade do empregado em se desligar da empresa.',
                instructions: 'Preencha todos os campos obrigatórios. Informe o período de aviso prévio desejado (trabalhado, indenizado ou dispensado). Este documento não substitui assessoria jurídica especializada.',
                legalNotice: 'Alguns direitos trabalhistas variam conforme o tipo de desligamento e convenções coletivas da categoria. Consulte sempre um advogado trabalhista para orientação específica.'
            },
            ferias: {
                name: 'Solicitação de Férias',
                description: 'Documento para solicitar formalmente o período de férias remuneradas.',
                instructions: 'Informe o período desejado e a quantidade de dias. As férias devem ser concedidas em até 12 meses após o período aquisitivo.',
                legalNotice: 'O empregador tem a prerrogativa de definir o período de férias. Este documento é apenas uma solicitação e não garante automaticamente a concessão no período desejado.'
            },
            advertencia: {
                name: 'Advertência Formal',
                description: 'Documento para formalizar advertência disciplinar ao empregado.',
                instructions: 'Descreva claramente a conduta inadequada, a data da ocorrência e a gravidade. A advertência deve estar vinculada ao regulamento interno da empresa.',
                legalNotice: 'A advertência é uma medida disciplinar que não implica automaticamente em demissão por justa causa. Serve como registro formal de conduta inadequada.'
            },
            atestado: {
                name: 'Atestado Informal',
                description: 'Documento para atestar ausência ou justificar falta ao trabalho.',
                instructions: 'Informe o período de ausência e o motivo. Este é um documento informal e não substitui atestados médicos quando necessário.',
                legalNotice: 'Atestados médicos têm validade legal específica. Este documento serve apenas para registro interno de ausências justificadas não médicas.'
            },
            rescisao: {
                name: 'Acordo de Rescisão',
                description: 'Documento para formalizar acordo de rescisão contratual entre empregado e empregador.',
                instructions: 'Informe todos os valores e condições do acordo. Ambas as partes devem estar cientes dos termos. Este documento não substitui assessoria jurídica.',
                legalNotice: 'A rescisão por acordo possui regras específicas na CLT. Recomenda-se sempre consultar um advogado trabalhista para garantir que todos os direitos sejam respeitados.'
            },
            reuniao: {
                name: 'Convocatória de Reunião',
                description: 'Documento para convocar formalmente reuniões com a equipe.',
                instructions: 'Informe data, hora, local e pauta da reunião. Solicite confirmação de presença dos participantes.',
                legalNotice: 'Este é um documento de comunicação interna. A presença em reuniões pode ser obrigatória conforme regras da empresa.'
            }
        };
    }
    
    // Validar campos obrigatórios por tipo de documento
    validateRequiredFields(data) {
        if (!data || !data.model) {
            return {
                valid: false,
                missingFields: ['model'],
                message: 'Tipo de documento não especificado.'
            };
        }
        
        const requiredFields = this.REQUIRED_FIELDS[data.model];
        if (!requiredFields) {
            return {
                valid: false,
                missingFields: [],
                message: 'Tipo de documento não suportado.'
            };
        }
        
        const missingFields = [];
        for (const field of requiredFields) {
            if (!data[field] || (typeof data[field] === 'string' && !data[field].trim())) {
                missingFields.push(field);
            }
        }
        
        if (missingFields.length > 0) {
            const fieldNames = {
                employeeName: 'Nome do Funcionário',
                employeePosition: 'Cargo',
                companyName: 'Nome da Empresa',
                effectiveDate: 'Data Efetiva',
                noticePeriod: 'Período de Aviso Prévio',
                CPF: 'CPF',
                CTPS: 'CTPS',
                vacationPeriod: 'Período de Férias',
                vacationDays: 'Dias de Férias',
                incidentDate: 'Data da Ocorrência',
                warningReason: 'Motivo da Advertência',
                severity: 'Gravidade',
                certificateStart: 'Data de Início',
                certificateEnd: 'Data de Término',
                certificateReason: 'Motivo do Atestado',
                severanceValue: 'Valor da Rescisão',
                paymentDate: 'Data de Pagamento',
                meetingDate: 'Data da Reunião',
                meetingTime: 'Horário',
                meetingLocation: 'Local',
                meetingAgenda: 'Pauta da Reunião'
            };
            
            const missingFieldNames = missingFields.map(f => fieldNames[f] || f).join(', ');
            return {
                valid: false,
                missingFields: missingFields,
                message: `Campos obrigatórios não preenchidos: ${missingFieldNames}`
            };
        }
        
        return {
            valid: true,
            missingFields: [],
            message: 'Todos os campos obrigatórios foram preenchidos.'
        };
    }
    
    // Verificar se um campo é de texto longo
    isLongTextField(fieldName) {
        return this.LONG_TEXT_FIELDS.some(suffix => fieldName.includes(suffix));
    }

    // Sanitizar string para prevenir injeção de comandos/scripts
    sanitizeInput(text, maxLength = null) {
        if (typeof text !== 'string') return '';
        // Remover caracteres de controle perigosos mas manter quebras de linha
        text = text.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g, '');
        // Limitar comprimento
        const limit = maxLength || this.MAX_SHORT_TEXT_LENGTH;
        if (text.length > limit) {
            text = text.substring(0, limit);
        }
        return text.trim();
    }

    // Gerador principal
    generateDocument(data) {
        if (!data || !data.model) {
            throw new Error('Dados incompletos para gerar documento');
        }
        
        // Validar campos obrigatórios
        const validation = this.validateRequiredFields(data);
        if (!validation.valid) {
            throw new Error(validation.message);
        }
        
        // Sanitizar todos os campos de texto do objeto data
        const sanitizedData = {};
        for (const key in data) {
            if (typeof data[key] === 'string') {
                const maxLength = this.isLongTextField(key) ? this.MAX_LONG_TEXT_LENGTH : this.MAX_SHORT_TEXT_LENGTH;
                sanitizedData[key] = this.sanitizeInput(data[key], maxLength);
            } else {
                sanitizedData[key] = data[key];
            }
        }
        
        const generator = this.templates[sanitizedData.model];
        if (!generator) {
            throw new Error('Tipo de documento não suportado');
        }
        
        try {
            return generator(sanitizedData);
        } catch (error) {
            console.error('Erro ao gerar documento:', error);
            throw new Error(`Falha ao gerar documento: ${error.message}`);
        }
    }

    // 1. PEDIDO DE DEMISSÃO
    generateResignationLetter(data) {
        const effectiveDate = data.effectiveDate ? this.formatDate(data.effectiveDate) : '(a definir)';
        const noticePeriodText = this.getNoticePeriodText(data.noticePeriod);
        // Sanitizar dados para prevenir XSS - escapar HTML em campos de usuário
        const cpf = this.escapeHtml(data.CPF || '[INFORME CPF]');
        const ctps = this.escapeHtml(data.CTPS || '[INFORME CTPS]');
        const employeeName = this.escapeHtml(data.employeeName || '[NOME DO FUNCIONÁRIO]');
        const employeePosition = this.escapeHtml(data.employeePosition || '[CARGO]');
        const companyName = this.escapeHtml(data.companyName ? data.companyName.toUpperCase() : '[NOME DA EMPRESA]');
        const companyAddress = this.escapeHtml(data.companyAddress || '[ENDEREÇO DA EMPRESA]');
        
        // Gerar local e data formatada
        const locationAndDate = this.formatLocationAndDate(data.companyAddress, data.documentDateFormatted);

        // Template otimizado para caber em EXATAMENTE 1 página A4
        return `<div style="${this.DOCUMENT_CONTAINER_STYLE}">
    <!-- Cabeçalho da empresa - margin-bottom reduzido de 15px para 8px -->
    <div style="text-align: center; margin-bottom: 8px; box-sizing: border-box;">
        <div style="font-weight: bold; font-size: 10pt; margin: 0; line-height: 1.2;">${companyName}</div>
        <div style="font-weight: bold; font-size: 9pt; margin: 0; line-height: 1.2;">${companyAddress}</div>
    </div>
    
    <!-- Título - margins reduzidos (20px->12px top, 15px->8px bottom), font-size 16pt->14pt -->
    <div style="text-align: center; margin: 12px 0 8px 0; box-sizing: border-box;">
        <div style="border-top: 2px solid #000; margin-bottom: 6px;"></div>
        <h2 style="margin: 6px 0; font-size: 14pt; font-weight: bold; line-height: 1.2;">PEDIDO DE DEMISSÃO</h2>
        <div style="border-bottom: 2px solid #000; margin-top: 6px;"></div>
    </div>
    
    <!-- Parágrafo de identificação - line-height 1.5->1.3, margin 15px->8px -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 6px 0; line-height: 1.3;">Eu, <strong>${employeeName}</strong>, brasileiro(a), portador(a) do CPF <strong>${cpf}</strong> 
        e Carteira de Trabalho <strong>${ctps}</strong>, na função de <strong>${employeePosition}</strong>, 
        venho por meio deste comunicar minha decisão de pedir demissão do cargo que 
        ocupo nesta empresa.</p>
    </div>
    
    <!-- Lista de valores devidos - margins reduzidos (12px->8px), line-height 1.5->1.3 -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 4px 0; line-height: 1.3;">Solicito que sejam calculados os valores devidos referentes a:</p>
        <ul style="margin: 4px 0 0 18px; padding: 0; line-height: 1.3;">
            <li style="margin: 2px 0; line-height: 1.3;">Saldo de salário</li>
            <li style="margin: 2px 0; line-height: 1.3;">Férias proporcionais + 1/3 constitucional</li>
            <li style="margin: 2px 0; line-height: 1.3;">13º salário proporcional</li>
            <li style="margin: 2px 0; line-height: 1.3;">${noticePeriodText}</li>
        </ul>
    </div>
    
    <!-- Data de desligamento - margin 12px->8px -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">Data efetiva do desligamento: <strong>${effectiveDate}</strong></p>
    </div>
    
    <!-- Declaração FGTS - margin 12px->8px, line-height 1.5->1.3 -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">Declaro estar ciente de que, no pedido de demissão por iniciativa do empregado,
        não há direito à multa de 40% do FGTS nem ao seguro-desemprego, conforme 
        legislação trabalhista vigente. Os direitos trabalhistas limitam-se às verbas 
        mencionadas acima, salvo disposições específicas em convenção coletiva ou 
        acordo individual.</p>
    </div>
    
    <!-- Disponibilidade - margin 12px->8px -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">Estou disponível para os procedimentos de desligamento conforme estabelecido 
        pela legislação trabalhista e normas internas da empresa.</p>
    </div>
    
    <!-- Separador - margin 20px->12px -->
    <div style="border-top: 2px solid #000; margin: 12px 0;"></div>
    
    <!-- Local e data - margin 15px->8px -->
    <div style="margin: 8px 0; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">${locationAndDate}</p>
    </div>
    
    <!-- Assinatura do funcionário - margins reduzidos (35px->20px, 20px->12px), page-break-inside: avoid -->
    <div style="margin: 20px 0 12px 0; page-break-inside: avoid; box-sizing: border-box;">
        <div style="border-top: 1px solid #000; width: 280px; margin: 0 auto;"></div>
        <p style="text-align: center; margin-top: 4px; line-height: 1.2;">Assinatura do Funcionário</p>
    </div>
    
    <!-- Separador - margin 20px->12px -->
    <div style="border-top: 2px solid #000; margin: 12px 0;"></div>
    
    <!-- Seção de recebimento - margin 15px->8px, page-break-inside: avoid -->
    <div style="margin: 8px 0; page-break-inside: avoid; box-sizing: border-box;">
        <p style="margin: 2px 0; line-height: 1.3;">Recebido por: ___________________________________________</p>
        <p style="margin: 2px 0; line-height: 1.3;">Cargo: ___________________________________________________</p>
        <p style="margin: 2px 0; line-height: 1.3;">Data: __/__/______</p>
    </div>
</div>`;
    }
    
    // Escapar HTML para prevenir XSS
    escapeHtml(text) {
        if (typeof text !== 'string') return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // 2. SOLICITAÇÃO DE FÉRIAS
    generateVacationRequest(data) {
        const period = data.vacationPeriod || '(período a ser definido)';
        const days = data.vacationDays || '30';
        const companyName = this.escapeHtml(data.companyName ? data.companyName.toUpperCase() : '[NOME DA EMPRESA]');
        const companyAddress = this.escapeHtml(data.companyAddress || '[ENDEREÇO DA EMPRESA]');
        const employeeName = this.escapeHtml(data.employeeName || '[NOME DO FUNCIONÁRIO]');
        const employeePosition = this.escapeHtml(data.employeePosition || '[CARGO]');
        const locationAndDate = this.formatLocationAndDate(data.companyAddress, data.documentDateFormatted);

        // Template otimizado para caber em EXATAMENTE 1 página A4
        return `<div style="${this.DOCUMENT_CONTAINER_STYLE}">
    <!-- Cabeçalho da empresa -->
    <div style="text-align: center; margin-bottom: 8px; box-sizing: border-box;">
        <div style="font-weight: bold; font-size: 10pt; margin: 0; line-height: 1.2;">${companyName}</div>
        <div style="font-weight: bold; font-size: 9pt; margin: 0; line-height: 1.2;">${companyAddress}</div>
    </div>
    
    <!-- Título -->
    <div style="text-align: center; margin: 12px 0 8px 0; box-sizing: border-box;">
        <div style="border-top: 2px solid #000; margin-bottom: 6px;"></div>
        <h2 style="margin: 6px 0; font-size: 14pt; font-weight: bold; line-height: 1.2;">SOLICITAÇÃO DE FÉRIAS</h2>
        <div style="border-bottom: 2px solid #000; margin-top: 6px;"></div>
    </div>
    
    <!-- Texto principal -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 6px 0; line-height: 1.3;">Eu, <strong>${employeeName}</strong>, funcionário(a) desta empresa no cargo de 
        <strong>${employeePosition}</strong>, venho por meio deste solicitar o gozo de minhas 
        férias referentes ao período aquisitivo vigente.</p>
    </div>
    
    <!-- Período e dias -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 4px 0; line-height: 1.3;">Solicito que as férias sejam concedidas no seguinte período: <strong>${period}</strong></p>
        <p style="margin: 0; line-height: 1.3;">Quantidade de dias: <strong>${days} dias</strong></p>
    </div>
    
    <!-- Declaração -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 4px 0; line-height: 1.3;">Declaro estar ciente de que, conforme legislação trabalhista:</p>
        <ul style="margin: 4px 0 0 18px; padding: 0; line-height: 1.3;">
            <li style="margin: 2px 0; line-height: 1.3;">As férias devem ser concedidas em até 12 meses após o período aquisitivo</li>
            <li style="margin: 2px 0; line-height: 1.3;">Receberei o valor correspondente com o adicional de 1/3 constitucional</li>
            <li style="margin: 2px 0; line-height: 1.3;">O período de férias pode ser dividido conforme acordo entre as partes</li>
        </ul>
    </div>
    
    <!-- Separador -->
    <div style="border-top: 2px solid #000; margin: 12px 0;"></div>
    
    <!-- Data -->
    <div style="margin: 8px 0; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">${locationAndDate}</p>
    </div>
    
    <!-- Assinatura do funcionário -->
    <div style="margin: 20px 0 12px 0; page-break-inside: avoid; box-sizing: border-box;">
        <div style="border-top: 1px solid #000; width: 280px; margin: 0 auto;"></div>
        <p style="text-align: center; margin-top: 4px; line-height: 1.2;">Assinatura do Funcionário</p>
    </div>
    
    <!-- Separador -->
    <div style="border-top: 2px solid #000; margin: 12px 0;"></div>
    
    <!-- Parecer departamento -->
    <div style="margin: 8px 0; page-break-inside: avoid; box-sizing: border-box;">
        <p style="margin: 2px 0; line-height: 1.3;">Parecer do Departamento Pessoal: ___________________________________</p>
        <p style="margin: 2px 0; line-height: 1.3;">Data de Agendamento: __/__/______</p>
    </div>
</div>`;
    }

    // 3. ADVERTÊNCIA FORMAL
    generateWarningLetter(data) {
        const severityText = this.getSeverityText(data.severity);
        const incidentDate = data.incidentDate ? this.formatDate(data.incidentDate) : data.documentDateFormatted || this.formatDate(new Date());
        const companyName = this.escapeHtml(data.companyName ? data.companyName.toUpperCase() : '[NOME DA EMPRESA]');
        const companyAddress = this.escapeHtml(data.companyAddress || '[ENDEREÇO DA EMPRESA]');
        const employeeName = this.escapeHtml(data.employeeName || '[NOME DO FUNCIONÁRIO]');
        const employeePosition = this.escapeHtml(data.employeePosition || '[CARGO]');
        const warningReason = this.escapeHtml(data.warningReason || 'Conduta inadequada no ambiente de trabalho.');
        const locationAndDate = this.formatLocationAndDate(data.companyAddress, data.documentDateFormatted);

        // Template otimizado para caber em EXATAMENTE 1 página A4
        return `<div style="${this.DOCUMENT_CONTAINER_STYLE}">
    <!-- Cabeçalho da empresa -->
    <div style="text-align: center; margin-bottom: 8px; box-sizing: border-box;">
        <div style="font-weight: bold; font-size: 10pt; margin: 0; line-height: 1.2;">${companyName}</div>
        <div style="font-weight: bold; font-size: 9pt; margin: 0; line-height: 1.2;">${companyAddress}</div>
    </div>
    
    <!-- Título -->
    <div style="text-align: center; margin: 12px 0 8px 0; box-sizing: border-box;">
        <div style="border-top: 2px solid #000; margin-bottom: 6px;"></div>
        <h2 style="margin: 6px 0; font-size: 14pt; font-weight: bold; line-height: 1.2;">ADVERTÊNCIA FORMAL</h2>
        <div style="border-bottom: 2px solid #000; margin-top: 6px;"></div>
    </div>
    
    <!-- Dados do funcionário -->
    <div style="margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 2px 0; line-height: 1.3;"><strong>Para:</strong> ${employeeName}</p>
        <p style="margin: 2px 0; line-height: 1.3;"><strong>Cargo:</strong> ${employeePosition}</p>
        <p style="margin: 2px 0; line-height: 1.3;"><strong>Data da Ocorrência:</strong> ${incidentDate}</p>
        <p style="margin: 2px 0; line-height: 1.3;"><strong>Gravidade:</strong> ${severityText}</p>
    </div>
    
    <!-- Subtítulo -->
    <div style="text-align: center; margin: 10px 0 8px 0; box-sizing: border-box;">
        <div style="border-top: 2px solid #000; margin-bottom: 4px;"></div>
        <h3 style="margin: 4px 0; font-size: 12pt; font-weight: bold; line-height: 1.2;">COMUNICADO DE ADVERTÊNCIA</h3>
        <div style="border-bottom: 2px solid #000; margin-top: 4px;"></div>
    </div>
    
    <!-- Texto principal -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 6px 0; line-height: 1.3;">A direção da empresa vem, por meio deste documento, formalizar uma advertência por:</p>
        <p style="margin: 6px 0; line-height: 1.3; font-style: italic;">"${warningReason}"</p>
        <p style="margin: 6px 0 0 0; line-height: 1.3;">Esta advertência é emitida com base no regulamento interno da empresa e na 
        legislação trabalhista vigente (CLT, art. 482). O objetivo desta medida 
        disciplinar é alertar sobre a necessidade de adequação de conduta e registrar 
        formalmente a ocorrência.</p>
    </div>
    
    <!-- Medidas disciplinares -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 4px 0; line-height: 1.3;">Medidas disciplinares progressivas previstas no regulamento interno:</p>
        <ul style="margin: 4px 0 0 18px; padding: 0; line-height: 1.3;">
            <li style="margin: 2px 0; line-height: 1.3;">Advertência verbal (orientação)</li>
            <li style="margin: 2px 0; line-height: 1.3;">Advertência escrita formal</li>
            <li style="margin: 2px 0; line-height: 1.3;">Suspensão temporária</li>
            <li style="margin: 2px 0; line-height: 1.3;">Em casos graves ou reincidências, possibilidade de dispensa por justa causa</li>
        </ul>
    </div>
    
    <!-- Separador -->
    <div style="border-top: 2px solid #000; margin: 12px 0;"></div>
    
    <!-- Ciência -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">O funcionário está ciente do conteúdo desta advertência. Este documento deverá ser assinado em duas vias.</p>
    </div>
    
    <!-- Assinatura empresa -->
    <div style="margin: 15px 0 8px 0; page-break-inside: avoid; box-sizing: border-box;">
        <div style="border-top: 1px solid #000; width: 280px; margin: 0 auto;"></div>
        <p style="text-align: center; margin-top: 4px; line-height: 1.2;">Assinatura do Representante da Empresa</p>
        <p style="text-align: center; margin: 2px 0; line-height: 1.2; font-size: 9pt;">Cargo: ____________________________</p>
    </div>
    
    <!-- Separador -->
    <div style="border-top: 2px solid #000; margin: 12px 0;"></div>
    
    <!-- Subtítulo ciência -->
    <div style="text-align: center; margin: 8px 0; box-sizing: border-box;">
        <h3 style="margin: 4px 0; font-size: 11pt; font-weight: bold; line-height: 1.2;">CIÊNCIA DO FUNCIONÁRIO</h3>
    </div>
    
    <!-- Declaração de ciência -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">Declaro ter recebido e compreendido o conteúdo desta advertência.</p>
    </div>
    
    <!-- Data e assinatura funcionário -->
    <div style="margin: 8px 0; box-sizing: border-box;">
        <p style="margin: 2px 0; line-height: 1.3;">Data: __/__/______</p>
    </div>
    
    <div style="margin: 15px 0 8px 0; page-break-inside: avoid; box-sizing: border-box;">
        <div style="border-top: 1px solid #000; width: 280px; margin: 0 auto;"></div>
        <p style="text-align: center; margin-top: 4px; line-height: 1.2;">Assinatura do Funcionário</p>
    </div>
</div>`;
    }

    // 4. ATESTADO
    generateCertificate(data) {
        const startDate = this.formatDate(data.certificateStart);
        const endDate = this.formatDate(data.certificateEnd);
        const period = startDate === endDate 
            ? `na data de ${startDate}`
            : `no período de ${startDate} a ${endDate}`;
        const companyName = this.escapeHtml(data.companyName ? data.companyName.toUpperCase() : '[NOME DA EMPRESA]');
        const companyAddress = this.escapeHtml(data.companyAddress || '[ENDEREÇO DA EMPRESA]');
        const employeeName = this.escapeHtml(data.employeeName || '[NOME DO FUNCIONÁRIO]');
        const employeePosition = this.escapeHtml(data.employeePosition || '[CARGO]');
        const certificateReason = this.escapeHtml(data.certificateReason || 'Assuntos pessoais que impossibilitaram a presença no trabalho.');
        const locationAndDate = this.formatLocationAndDate(data.companyAddress, data.documentDateFormatted);

        // Template otimizado para caber em EXATAMENTE 1 página A4
        return `<div style="${this.DOCUMENT_CONTAINER_STYLE}">
    <!-- Cabeçalho da empresa -->
    <div style="text-align: center; margin-bottom: 8px; box-sizing: border-box;">
        <div style="font-weight: bold; font-size: 10pt; margin: 0; line-height: 1.2;">${companyName}</div>
        <div style="font-weight: bold; font-size: 9pt; margin: 0; line-height: 1.2;">${companyAddress}</div>
    </div>
    
    <!-- Título -->
    <div style="text-align: center; margin: 12px 0 8px 0; box-sizing: border-box;">
        <div style="border-top: 2px solid #000; margin-bottom: 6px;"></div>
        <h2 style="margin: 6px 0; font-size: 14pt; font-weight: bold; line-height: 1.2;">ATESTADO</h2>
        <div style="border-bottom: 2px solid #000; margin-top: 6px;"></div>
    </div>
    
    <!-- Texto principal -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 6px 0; line-height: 1.3;">Atesto para os devidos fins que o(a) Sr(a). <strong>${employeeName}</strong>, 
        ocupante do cargo de <strong>${employeePosition}</strong> nesta empresa, não compareceu 
        ao trabalho <strong>${period}</strong> devido a:</p>
    </div>
    
    <!-- Motivo -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3; font-style: italic;">"${certificateReason}"</p>
    </div>
    
    <!-- Observação -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">Este documento serve como justificativa para a ausência e não implica em 
        qualquer responsabilidade trabalhista adicional, exceto se estabelecido em 
        acordo ou convenção coletiva.</p>
    </div>
    
    <!-- Separador -->
    <div style="border-top: 2px solid #000; margin: 12px 0;"></div>
    
    <!-- Data -->
    <div style="margin: 8px 0; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">${locationAndDate}</p>
    </div>
    
    <!-- Assinatura -->
    <div style="margin: 20px 0 12px 0; page-break-inside: avoid; box-sizing: border-box;">
        <div style="border-top: 1px solid #000; width: 280px; margin: 0 auto;"></div>
        <p style="text-align: center; margin-top: 4px; line-height: 1.2;">Assinatura do Responsável</p>
        <p style="text-align: center; margin: 2px 0; line-height: 1.2; font-size: 9pt;">Cargo: ____________________________</p>
    </div>
</div>`;
    }

    // 5. ACORDO DE RESCISÃO
    generateSeveranceAgreement(data) {
        const value = data.severanceValue ? `R$ ${parseFloat(data.severanceValue).toFixed(2).replace('.', ',')}` : 'a ser definido';
        const paymentDate = data.paymentDate ? this.formatDate(data.paymentDate) : '(a definir)';
        const conditions = data.additionalConditions ? `\n6. ${data.additionalConditions}` : '';
        const cpf = this.escapeHtml(data.CPF || '[INFORME CPF]');
        const ctps = this.escapeHtml(data.CTPS || '[INFORME CTPS]');
        const companyName = this.escapeHtml(data.companyName ? data.companyName.toUpperCase() : '[NOME DA EMPRESA]');
        const companyAddress = this.escapeHtml(data.companyAddress || '[ENDEREÇO DA EMPRESA]');
        const employeeName = this.escapeHtml(data.employeeName || '[NOME DO FUNCIONÁRIO]');
        const employeePosition = this.escapeHtml(data.employeePosition || '[CARGO]');
        const locationAndDate = this.formatLocationAndDate(data.companyAddress, data.documentDateFormatted);

        // Template otimizado para caber em EXATAMENTE 1 página A4
        return `<div style="${this.DOCUMENT_CONTAINER_STYLE}">
    <!-- Cabeçalho da empresa -->
    <div style="text-align: center; margin-bottom: 8px; box-sizing: border-box;">
        <div style="font-weight: bold; font-size: 10pt; margin: 0; line-height: 1.2;">${companyName}</div>
        <div style="font-weight: bold; font-size: 9pt; margin: 0; line-height: 1.2;">${companyAddress}</div>
    </div>
    
    <!-- Título -->
    <div style="text-align: center; margin: 12px 0 8px 0; box-sizing: border-box;">
        <div style="border-top: 2px solid #000; margin-bottom: 6px;"></div>
        <h2 style="margin: 6px 0; font-size: 14pt; font-weight: bold; line-height: 1.2;">ACORDO DE RESCISÃO CONTRATUAL</h2>
        <div style="border-bottom: 2px solid #000; margin-top: 6px;"></div>
    </div>
    
    <!-- Partes do acordo -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 6px 0; line-height: 1.3;">Entre <strong>${companyName}</strong>, com sede em ${companyAddress}, doravante 
        denominada EMPRESA, e <strong>${employeeName}</strong>, portador(a) do CPF <strong>${cpf}</strong> 
        e Carteira de Trabalho <strong>${ctps}</strong>, ocupante do cargo de 
        <strong>${employeePosition}</strong>, doravante denominado(a) FUNCIONÁRIO(A), celebra-se 
        o presente acordo de rescisão contratual, sob as seguintes condições:</p>
    </div>
    
    <!-- Condições -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <ul style="margin: 4px 0 0 18px; padding: 0; line-height: 1.3;">
            <li style="margin: 2px 0; line-height: 1.3;">As partes, de comum acordo, resolvem o contrato de trabalho vigente.</li>
            <li style="margin: 2px 0; line-height: 1.3;">A EMPRESA pagará ao FUNCIONÁRIO(A) a importância de <strong>${value}</strong>, 
            correspondente a todos os direitos trabalhistas decorrentes da rescisão.</li>
            <li style="margin: 2px 0; line-height: 1.3;">Data para pagamento: <strong>${paymentDate}</strong></li>
            <li style="margin: 2px 0; line-height: 1.3;">O FUNCIONÁRIO(A) declara estar ciente de que, com a assinatura deste 
            acordo, renuncia a qualquer ação trabalhista referente ao período contratual.</li>
            <li style="margin: 2px 0; line-height: 1.3;">O FUNCIONÁRIO(A) deverá devolver todos os bens da empresa em seu poder 
            até a data do desligamento.</li>${conditions ? `<li style="margin: 2px 0; line-height: 1.3;">${this.escapeHtml(conditions.substring(3))}</li>` : ''}
        </ul>
    </div>
    
    <!-- Declaração final -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">As partes declaram estar cientes do teor deste acordo e assinam-no em duas 
        vias de igual teor.</p>
    </div>
    
    <!-- Separador -->
    <div style="border-top: 2px solid #000; margin: 12px 0;"></div>
    
    <!-- Data -->
    <div style="margin: 8px 0; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">${locationAndDate}</p>
    </div>
    
    <!-- Assinatura empresa -->
    <div style="margin: 15px 0 8px 0; page-break-inside: avoid; box-sizing: border-box;">
        <div style="border-top: 1px solid #000; width: 280px; margin: 0 auto;"></div>
        <p style="text-align: center; margin-top: 4px; line-height: 1.2;">Representante Legal da Empresa</p>
        <p style="text-align: center; margin: 2px 0; line-height: 1.2; font-size: 9pt;">Cargo: ____________________________</p>
    </div>
    
    <!-- Assinatura funcionário -->
    <div style="margin: 15px 0 8px 0; page-break-inside: avoid; box-sizing: border-box;">
        <div style="border-top: 1px solid #000; width: 280px; margin: 0 auto;"></div>
        <p style="text-align: center; margin-top: 4px; line-height: 1.2;">${employeeName}</p>
    </div>
</div>`;
    }

    // 6. CONVOCATÓRIA DE REUNIÃO
    generateMeetingConvocation(data) {
        const meetingDate = data.meetingDate ? this.formatDate(data.meetingDate) : '(a definir)';
        const time = data.meetingTime || '(horário a definir)';
        const location = data.meetingLocation || 'Sala de Reuniões';
        const agenda = data.meetingAgenda || 
            '1. Abertura e apresentação dos objetivos\n2. Discussão sobre metas trimestrais\n3. Ajustes de processos internos\n4. Feedbacks e sugestões\n5. Encerramento';
        const companyName = this.escapeHtml(data.companyName ? data.companyName.toUpperCase() : '[NOME DA EMPRESA]');
        const companyAddress = this.escapeHtml(data.companyAddress || '[ENDEREÇO DA EMPRESA]');
        const employeeName = this.escapeHtml(data.employeeName || '[NOME DO FUNCIONÁRIO]');
        const employeePosition = this.escapeHtml(data.employeePosition || '[CARGO]');
        const locationAndDate = this.formatLocationAndDate(data.companyAddress, data.documentDateFormatted);
        
        // Converter agenda em lista HTML
        const agendaItems = agenda.split('\n').map(item => {
            const trimmed = item.trim();
            if (trimmed) {
                // Remove numeração/bullets (números, letras, hífen, asterisco, bullet)
                const content = trimmed.replace(/^[\d\w]+\.\s*|^[-*•]\s*/, '');
                return `<li style="margin: 2px 0; line-height: 1.3;">${this.escapeHtml(content)}</li>`;
            }
            return '';
        }).filter(item => item).join('');

        // Template otimizado para caber em EXATAMENTE 1 página A4
        return `<div style="${this.DOCUMENT_CONTAINER_STYLE}">
    <!-- Cabeçalho da empresa -->
    <div style="text-align: center; margin-bottom: 8px; box-sizing: border-box;">
        <div style="font-weight: bold; font-size: 10pt; margin: 0; line-height: 1.2;">${companyName}</div>
        <div style="font-weight: bold; font-size: 9pt; margin: 0; line-height: 1.2;">${companyAddress}</div>
    </div>
    
    <!-- Título -->
    <div style="text-align: center; margin: 12px 0 8px 0; box-sizing: border-box;">
        <div style="border-top: 2px solid #000; margin-bottom: 6px;"></div>
        <h2 style="margin: 6px 0; font-size: 14pt; font-weight: bold; line-height: 1.2;">CONVOCATÓRIA PARA REUNIÃO</h2>
        <div style="border-bottom: 2px solid #000; margin-top: 6px;"></div>
    </div>
    
    <!-- Cabeçalho do documento -->
    <div style="margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 2px 0; line-height: 1.3;"><strong>Para:</strong> Todos os funcionários do departamento</p>
        <p style="margin: 2px 0; line-height: 1.3;"><strong>De:</strong> ${employeeName} - ${employeePosition}</p>
        <p style="margin: 2px 0; line-height: 1.3;"><strong>Data do Documento:</strong> ${locationAndDate}</p>
    </div>
    
    <!-- Subtítulo -->
    <div style="text-align: center; margin: 10px 0 8px 0; box-sizing: border-box;">
        <div style="border-top: 2px solid #000; margin-bottom: 4px;"></div>
        <h3 style="margin: 4px 0; font-size: 12pt; font-weight: bold; line-height: 1.2;">CONVOCAÇÃO</h3>
        <div style="border-bottom: 2px solid #000; margin-top: 4px;"></div>
    </div>
    
    <!-- Texto principal -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">Convocamos todos os membros do departamento para uma reunião que será realizada:</p>
    </div>
    
    <!-- Detalhes da reunião -->
    <div style="margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 2px 0; line-height: 1.3;"><strong>Data:</strong> ${meetingDate}</p>
        <p style="margin: 2px 0; line-height: 1.3;"><strong>Hora:</strong> ${time}</p>
        <p style="margin: 2px 0; line-height: 1.3;"><strong>Local:</strong> ${location}</p>
    </div>
    
    <!-- Pauta da reunião -->
    <div style="margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 4px 0; line-height: 1.3;"><strong>Pauta da Reunião:</strong></p>
        <ul style="margin: 4px 0 0 18px; padding: 0; line-height: 1.3;">
            ${agendaItems}
        </ul>
    </div>
    
    <!-- Confirmação -->
    <div style="text-align: justify; margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0; line-height: 1.3;">Solicitamos a confirmação de presença até 24 horas antes da reunião.</p>
    </div>
    
    <!-- Separador -->
    <div style="border-top: 2px solid #000; margin: 12px 0;"></div>
    
    <!-- Assinatura -->
    <div style="margin: 8px 0; line-height: 1.3; box-sizing: border-box;">
        <p style="margin: 0 0 4px 0; line-height: 1.3;">Atenciosamente,</p>
    </div>
    
    <div style="margin: 15px 0 8px 0; page-break-inside: avoid; box-sizing: border-box;">
        <div style="border-top: 1px solid #000; width: 280px; margin: 0 auto;"></div>
        <p style="text-align: center; margin-top: 4px; line-height: 1.2;">${employeeName}</p>
        <p style="text-align: center; margin: 2px 0; line-height: 1.2; font-size: 9pt;">${employeePosition}</p>
    </div>
</div>`;
    }

    // FUNÇÕES AUXILIARES
    formatDate(dateString) {
        if (!dateString || dateString === '(a definir)') return dateString || '';
        
        try {
            // Se já está no formato DD/MM/AAAA, retornar como está
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
                return dateString;
            }
            
            let date;
            
            // Tentar parsear ISO string (YYYY-MM-DD ou formato completo)
            if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                date = new Date(dateString);
            }
            // Tentar parsear formato DD-MM-YYYY
            else if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
                const [day, month, year] = dateString.split('-');
                date = new Date(year, month - 1, day);
            }
            // Tentar criar Date object diretamente para outros formatos
            else {
                date = new Date(dateString);
            }
            
            // Verificar se a data é válida
            if (isNaN(date.getTime())) {
                return dateString;
            }
            
            // Formatar para DD/MM/AAAA em pt-BR
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch (e) {
            return dateString;
        }
    }

    getNoticePeriodText(type) {
        const texts = {
            trabalhado: 'Aviso prévio trabalhado',
            indenizado: 'Aviso prévio indenizado',
            dispensado: 'Aviso prévio dispensado pelo empregador'
        };
        return texts[type] || 'Aviso prévio (conforme acordo)';
    }

    getSeverityText(severity) {
        const texts = {
            leve: 'Leve',
            media: 'Média',
            grave: 'Grave'
        };
        return texts[severity] || 'Média';
    }
    
    // Formatar data por extenso em português
    formatDateExtended(dateString) {
        if (!dateString) {
            dateString = new Date();
        }
        
        try {
            let date;
            
            // Se já for um objeto Date
            if (dateString instanceof Date) {
                date = dateString;
            }
            // Tentar parsear ISO string (YYYY-MM-DD ou formato completo)
            else if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                date = new Date(dateString);
            }
            // Tentar parsear formato DD/MM/YYYY
            else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
                const [day, month, year] = dateString.split('/');
                date = new Date(year, month - 1, day);
            }
            // Tentar criar Date object diretamente para outros formatos
            else {
                date = new Date(dateString);
            }
            
            // Verificar se a data é válida
            if (isNaN(date.getTime())) {
                date = new Date();
            }
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = this.MONTHS_PT[date.getMonth()];
            const year = date.getFullYear();
            
            return `${day} de ${month} de ${year}`;
        } catch (e) {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = this.MONTHS_PT[now.getMonth()];
            const year = now.getFullYear();
            return `${day} de ${month} de ${year}`;
        }
    }
    
    // Extrair cidade do endereço
    extractCity(address) {
        if (!address || address === '[ENDEREÇO DA EMPRESA]') {
            return 'São Paulo';
        }
        
        // Tentar extrair cidade do formato: "Rua X, 123 - Cidade/Estado"
        // ou "Av. Y, 456 - Cidade - Estado"
        // Suporta tanto hífen ASCII (-) quanto en-dash (–) para compatibilidade
        const patterns = [
            /[-–]\s*([A-Za-zÀ-ÿ\s]+)\s*[\/\-]/,  // Cidade antes de / ou -
            /[-–]\s*([A-Za-zÀ-ÿ\s]+)\s*$/,        // Cidade no final
        ];
        
        for (const pattern of patterns) {
            const match = address.match(pattern);
            if (match && match[1]) {
                return match[1].trim();
            }
        }
        
        // Se não conseguir extrair, retornar São Paulo como padrão
        return 'São Paulo';
    }
    
    // Formatar local e data no padrão brasileiro
    formatLocationAndDate(address, documentDate) {
        const city = this.extractCity(address);
        const dateExtended = this.formatDateExtended(documentDate);
        return `${city}, ${dateExtended}`;
    }

    // Geração de exemplo para cada tipo
    generateExample(modelType) {
        const examples = {
            companyName: 'Tech Solutions Ltda',
            companyAddress: 'Av. Paulista, 1000 - São Paulo/SP',
            employeeName: 'João da Silva',
            employeePosition: 'Analista de Sistemas',
            documentDate: new Date().toISOString().split('T')[0],
            documentDateFormatted: new Date().toLocaleDateString('pt-BR'),
            model: modelType
        };

        switch(modelType) {
            case 'demissao':
                examples.effectiveDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                examples.noticePeriod = 'trabalhado';
                examples.CPF = '123.456.789-00';
                examples.CTPS = '12345 - Série 0001';
                break;
            case 'ferias':
                examples.vacationPeriod = '01/12/2023 a 31/12/2023';
                examples.vacationDays = '30';
                break;
            case 'advertencia':
                examples.warningReason = 'Atrasos recorrentes no horário de entrada durante o mês de outubro.';
                examples.incidentDate = new Date().toISOString().split('T')[0];
                examples.severity = 'media';
                break;
            case 'atestado':
                examples.certificateReason = 'Consulta médica agendada com urgência.';
                examples.certificateStart = new Date().toISOString().split('T')[0];
                examples.certificateEnd = new Date().toISOString().split('T')[0];
                break;
            case 'rescisao':
                examples.severanceValue = '5000.00';
                examples.paymentDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                examples.additionalConditions = 'O funcionário se compromete a manter sigilo sobre informações confidenciais da empresa.';
                examples.CPF = '123.456.789-00';
                examples.CTPS = '12345 - Série 0001';
                break;
            case 'reuniao':
                examples.meetingDate = new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                examples.meetingTime = '14:00';
                examples.meetingLocation = 'Sala de Reuniões Principal';
                examples.meetingAgenda = '1. Abertura e boas-vindas\n2. Apresentação dos resultados do trimestre\n3. Discussão sobre novas metas\n4. Feedbacks da equipe\n5. Encerramento';
                break;
            default:
                examples.effectiveDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                examples.noticePeriod = 'trabalhado';
        }

        return this.generateDocument(examples);
    }
}

// Inicializar quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', () => {
    if (!window.documentGenerator) {
        window.documentGenerator = new DocumentGenerator();
    }
});

// Exportar para uso global
window.DocumentGenerator = DocumentGenerator;
